<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Salida_model extends CI_Model
{
    private $session_data = "";
    function __construct()
    {
        parent::__construct();
                
        $this->session_data = $this->session->userdata('logged_in');

    }
    
    /*
     * Get salida by salida_id
     */
    function get_salida($salida_id)
    {
        $salida = $this->db->query("
            SELECT
                *

            FROM
                `salida`

            WHERE
                `salida_id` = ?
        ",array($salida_id))->result_array();

        return $salida;
    }
    

    function get_50_salida($gestion)
    {
        $salida = $this->db->query("
            SELECT
                s.*, e.estado_color, e.estado_descripcion, u.unidad_nombre,
                g.gestion_nombre, us.usuario_nombre, us.usuario_imagen, p.programa_nombre

            FROM
                salida s
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN unidad u on s.unidad_id = u.unidad_id
            LEFT JOIN gestion g on s.gestion_id = g.gestion_id
            LEFT JOIN programa p on s.programa_id = p.programa_id
            LEFT JOIN usuario us on s.usuario_id = us.usuario_id
            WHERE s.gestion_id =".$gestion."
            ORDER BY s.salida_fechasal desc, s.salida_hora desc limit 50
        ")->result_array();

        return $salida;
    }

    function get_tipo_salida($parametro,$categoria,$gestion)
    {
        $salida = $this->db->query("
            SELECT
                s.*, e.estado_color, e.estado_descripcion, u.unidad_nombre,
                g.gestion_nombre, us.usuario_nombre, us.usuario_imagen, p.programa_nombre

            FROM
                salida s
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN unidad u on s.unidad_id = u.unidad_id
            LEFT JOIN gestion g on s.gestion_id = g.gestion_id
            LEFT JOIN programa p on s.programa_id = p.programa_id
            LEFT JOIN usuario us on s.usuario_id = us.usuario_id

            WHERE
            s.gestion_id =".$gestion." and 
                (s.salida_doc like '%".$parametro."%')
                ".$categoria."
            
            ORDER BY s.salida_fechasal desc, s.salida_hora desc
        ")->result_array();

        return $salida;
    }
    /*
     * Obtener salida por id
     */
    function get_salida_by_id($salida_id)
    {
        $salida = $this->db->query("
            SELECT
                *

            FROM
                `salida`

            WHERE
                `salida_id` = ?
        ",array($salida_id))->row_array();

        return $salida;
    }
        
    /*
     * Get all salida
     */
    function get_all_salida($gestion)
    {
        $salida = $this->db->query("
            SELECT
                s.*, e.estado_color, e.estado_descripcion, u.unidad_nombre,
                g.gestion_nombre, us.usuario_nombre, us.usuario_imagen, p.programa_nombre

            FROM
                salida s
            LEFT JOIN estado e on s.estado_id = e.estado_id
            LEFT JOIN unidad u on s.unidad_id = u.unidad_id
            LEFT JOIN gestion g on s.gestion_id = g.gestion_id
            LEFT JOIN programa p on s.programa_id = p.programa_id
            LEFT JOIN usuario us on s.usuario_id = us.usuario_id
            WHERE s.gestion_id =".$gestion."
            ORDER BY s.salida_fechasal desc, s.salida_hora desc
        ")->result_array();

        return $salida;
    }
    function get_all_salidas($gestion)
    {
        $salida = $this->db->query("
            SELECT * from salida
            WHERE gestion_id =".$gestion)->result_array();

        return $salida;
    }
    /*
     * Cargar detalle_salida
     */
    function cargar_detalle_salida($usuario_id, $salida_id)
    {
        $sql ="insert into detalle_salida_aux(
                salida_id, articulo_id, programa_id,
                detallesal_cantidad, detallesal_precio, detallesal_total,
                usuario_id, detalleing_id, ingreso_id, factura_numero
                )
                (select 
                salida_id, articulo_id, programa_id,
                detallesal_cantidad, detallesal_precio, detallesal_total,
                ".$usuario_id." as usuario_id, detalleing_id, ingreso_id, factura_numero
                from detalle_salida
                where salida_id = ".$salida_id.")";
        
        $this->db->query($sql);

        return true;
    }
        
        
    /*
     * mostrar detalle auxiliar
     */
    function get_detalle_aux($usuario_id,$salida_id)
    {
        $sql ="select *  from detalle_salida_aux d, articulo a                 
                where d.articulo_id = a.articulo_id
                and d.usuario_id = ".$usuario_id."
                and d.salida_id = ".$salida_id." 
                ORDER BY d.detallesal_id";  
        $salida = $this->db->query($sql)->result_array();

        return $salida;
    }
        
    /*
     * function to add new salida
     */
    function add_salida($params)
    {
        //********** registro en bitacora ***********//
        $sql = json_encode($params);
        $this->bitacora($sql,'INSERT');
        //********** fin registro en bitacora ***********//        
        
        $this->db->insert('salida',$params);
        return $this->db->insert_id();
    }
    
    /*
     * function to update salida
     */
    function update_salida($salida_id,$params)
    {
        //********** registro en bitacora ***********//
        $sql = json_encode($params);
        $this->bitacora($sql,'UPDATE');
        //********** fin registro en bitacora ***********//        
        $this->db->where('salida_id',$salida_id);
        return $this->db->update('salida',$params);
    }
    
    /*
     * function to delete salida
     */
    function delete_salida($salida_id)
    {
        //********** registro en bitacora ***********//
        $sql = "salida_id: ".$salida_id;
        $this->bitacora($sql,'DELETE');
        //********** fin registro en bitacora ***********//        
        return $this->db->delete('salida',array('salida_id'=>$salida_id));
    }
    
    
    /*
     * Ejecutar Consulta SQL
     */
    function ejecutar($sql){
         
        //********** registro en bitacora ***********//
        $this->bitacora($sql,'EJECUTAR');
        //********** fin registro en bitacora ***********//        
        $this->db->query($sql);
        return $this->db->insert_id();
    }


    /*
     * Consulta SQL
     */
    function consultar($sql){
                 
        //********** registro en bitacora ***********//
        $this->bitacora($sql,'CONSULTAR');
        //********** fin registro en bitacora ***********//        
        $resultado = $this->db->query($sql)->result_array();        
        return $resultado;
    }
    
    function get_salida_completa($salida_id)
    {
        $pedido = "
                    SELECT
                    s.*, u.unidad_nombre, p.programa_nombre, e.estado_descripcion, t.usuario_id, t.usuario_nombre

                    from salida s

                    LEFT JOIN unidad u on u.unidad_id = s.unidad_id
                    LEFT JOIN programa p on p.programa_id = s.programa_id
                    LEFT JOIN estado e on e.estado_id = s.programa_id
                    LEFT JOIN usuario t on t.usuario_id = s.usuario_id

                    where 

                    s.salida_id = ".$salida_id;
        $result = $this->db->query($pedido)->result_array();

        return $result;
    }           
                
    function bitacora($sql, $operacion){
        
        $usuario_id = $this->session_data['usuario_id'];
        
        $bitacora_fecha = "'".date("Y-m-d")."'";
        $bitacora_hora = "'".date("H:i:s")."'";
        $bitacora_operacion = "'".$operacion." "."SALIDA'";
        $bitacora_consulta = "'".$sql."'";
        $bitacora_anterior ="''";
        
        $sql = "insert into bitacora(bitacora_fecha,bitacora_hora,bitacora_operacion,bitacora_consulta,bitacora_anterior,usuario_id) value(".
                $bitacora_fecha.",".$bitacora_hora.",".$bitacora_operacion.",".$bitacora_consulta.",".$bitacora_anterior.",".$usuario_id.")";
    
        $this->db->query($sql);
        return true;
    }
}
