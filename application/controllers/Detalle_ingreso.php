<?php
/* 
 * Generated by CRUDigniter v3.2 
 * www.crudigniter.com
 */
 
class Detalle_ingreso extends CI_Controller{
    private $session_data = "";
    function __construct()
    {
        parent::__construct();
        $this->load->model('Detalle_ingreso_model');
        $this->load->model('Programa_model');
        if ($this->session->userdata('logged_in')) {
            $this->session_data = $this->session->userdata('logged_in');
        }else {
            redirect('', 'refresh');
        }
    } 
    /* *****Funcion que verifica el acceso al sistema**** */
    private function acceso($id_rol){
        $rolusuario = $this->session_data['rol'];
        if($rolusuario[$id_rol-1]['rolusuario_asignado'] == 1){
            return true;
        }else{
            $data['_view'] = 'login/mensajeacceso';
            $this->load->view('layouts/main',$data);
        }
    }
    /*
     * Listing of detalle_ingreso
     */
    function index()
    {
        $this->Detalle_ingreso_model->bitacora("ACCESO A MODULO","INDEX DETALLE INGRESO");
        
        if($this->acceso(16)){
            $data['detalle_ingreso'] = $this->Detalle_ingreso_model->get_all_detalle_ingreso();

            $data['_view'] = 'detalle_ingreso/index';
            $this->load->view('layouts/main',$data);
        }
    }
    
    function kardex($programa_id,$articulo_id,$fecha_desde,$fecha_hasta,$gestion_inicio)
    {
        $this->Detalle_ingreso_model->bitacora("ACCESO A MODULO","KARDEX DETALLE INGRESO");
        
        $gestion = $this->session_data['gestion_id'];
        
        if($this->acceso(16)){
            
            $data['gestion_nombre'] = $this->session_data['gestion_nombre'];
            $this->load->model('Institucion_model');
            $data['institucion'] = $this->Institucion_model->get_all_institucion();
            $this->load->model('Programa_model');
            $data['articulo'] = $this->Programa_model->get_articulo_porprogramadatos($articulo_id,$programa_id);
            $data['fecha_ini'] = $fecha_desde;
            $data['kardex'] = $this->Programa_model->mostrar_kardex($programa_id,$articulo_id,$fecha_desde,$fecha_hasta,$gestion_inicio,$gestion);
            $data['fecha_fin'] = $fecha_hasta;
            $data['_view'] = 'articulo/kardex';
            $this->load->view('layouts/main',$data);
            
        }
    }
    
    function saldo_kardex()
    {
        
        $programa_id = $this->input->post("programa_id");
        $articulo_id = $this->input->post("articulo_id");
        $fecha_desde = $this->input->post("fecha_desde");
        $fecha_hasta = $this->input->post("fecha_hasta");
        $gestion_inicio  = $this->input->post("gestion_inicio");
        
        $gestion = $this->session_data['gestion_id'];
        
        $kardex = $this->Programa_model->mostrar_kardex($programa_id,$articulo_id,$fecha_desde,$fecha_hasta,$gestion_inicio,$gestion);
            

            $saldo = 0;
            $total_compras = 0;
            $total_ventas = 0;
            $total_precioventas = 0;
            $saldo_total = 0;

            $cantidad_total = 0;

            $precio_total = 0;
   
            foreach($kardex as $ar){ 
         
                if ($ar['cantidad_ingreso']>0) 
                        $saldo_total += ($ar['saldo'] * $ar['precio_ingreso']);
         
                $saldo += $ar['cantidad_ingreso'] - $ar['cantidad_salida'];
                            $total_compras += $ar['cantidad_ingreso'];
                            $total_ventas += $ar['cantidad_salida'];
                            $total_precioventas += $ar['total_salida'];

              
                $precio_total += ($ar["total_ingreso"] - $ar["total_salida"]);
            
            
            } 
            
           $saldo_final =  $total_compras - $total_ventas;
           $precio_final = $precio_total;
           //$resultado = array(0 => $saldo_final,1 => $precio_final);
           $resultado = number_format($precio_final,2,".",",");
           
           echo json_encode($resultado);
        
    }

     

    /*
     * Adding a new detalle_ingreso
     */
    function add()
    {
        $this->Detalle_ingreso_model->bitacora("ACCESO A MODULO","ADD DETALLE INGRESO");
        if($this->acceso(16)){
            if(isset($_POST) && count($_POST) > 0)     
            {   
                $params = array(
                    'proveedor_id' => $this->input->post('proveedor_id'),
                    'factura_id' => $this->input->post('factura_id'),
                    'articulo_id' => $this->input->post('articulo_id'),
                    'ingreso_id' => $this->input->post('ingreso_id'),
                    'programa_id' => $this->input->post('programa_id'),
                    'detalleing_cantidad' => $this->input->post('detalleing_cantidad'),
                    'detalleing_precio' => $this->input->post('detalleing_precio'),
                    'detalleing_total' => $this->input->post('detalleing_total'),
                );

                $detalle_ingreso_id = $this->Detalle_ingreso_model->add_detalle_ingreso($params);
                redirect('detalle_ingreso/index');
            }
            else
            {
                            $this->load->model('Proveedor_model');
                            $data['all_proveedor'] = $this->Proveedor_model->get_all_proveedor();

                            $this->load->model('Factura_model');
                            $data['all_factura'] = $this->Factura_model->get_all_factura();

                            $this->load->model('Articulo_model');
                            $data['all_articulo'] = $this->Articulo_model->get_all_articulo();

                            $this->load->model('Ingreso_model');
                            $data['all_ingreso'] = $this->Ingreso_model->get_all_ingreso();

                            $this->load->model('Programa_model');
                            $data['all_programa'] = $this->Programa_model->get_all_programa();

                $data['_view'] = 'detalle_ingreso/add';
                $this->load->view('layouts/main',$data);
            }
        }
    }  

    /*
     * Editing a detalle_ingreso
     */
//    function edit($detalleing_id)
//    {
//        if($this->acceso(16)){
//            // check if the detalle_ingreso exists before trying to edit it
//            $data['detalle_ingreso'] = $this->Detalle_ingreso_model->get_detalle_ingreso($detalleing_id);
//
//            if(isset($data['detalle_ingreso']['detalleing_id']))
//            {
//                if(isset($_POST) && count($_POST) > 0)     
//                {   
//                    $params = array(
//                                            'proveedor_id' => $this->input->post('proveedor_id'),
//                                            'factura_id' => $this->input->post('factura_id'),
//                                            'articulo_id' => $this->input->post('articulo_id'),
//                                            'ingreso_id' => $this->input->post('ingreso_id'),
//                                            'programa_id' => $this->input->post('programa_id'),
//                                            'detalleing_cantidad' => $this->input->post('detalleing_cantidad'),
//                                            'detalleing_precio' => $this->input->post('detalleing_precio'),
//                                            'detalleing_total' => $this->input->post('detalleing_total'),
//                    );
//
//                    $this->Detalle_ingreso_model->update_detalle_ingreso($detalleing_id,$params);            
//                    redirect('detalle_ingreso/index');
//                }
//                else
//                {
//                                    $this->load->model('Proveedor_model');
//                                    $data['all_proveedor'] = $this->Proveedor_model->get_all_proveedor();
//
//                                    $this->load->model('Factura_model');
//                                    $data['all_factura'] = $this->Factura_model->get_all_factura();
//
//                                    $this->load->model('Articulo_model');
//                                    $data['all_articulo'] = $this->Articulo_model->get_all_articulo();
//
//                                    $this->load->model('Ingreso_model');
//                                    $data['all_ingreso'] = $this->Ingreso_model->get_all_ingreso();
//
//                                    $this->load->model('Programa_model');
//                                    $data['all_programa'] = $this->Programa_model->get_all_programa();
//
//                    $data['_view'] = 'detalle_ingreso/edit';
//                    $this->load->view('layouts/main',$data);
//                }
//            }
//            else
//                show_error('The detalle_ingreso you are trying to edit does not exist.');
//        }
//    } 
    
    function edit($detalleing_id)
    {  
        $this->Detalle_ingreso_model->bitacora("ACCESO A MODULO","EDIT DETALLE INGRESO");
         if($this->acceso(16)){
        
        // check if the detalle_ingreso exists before trying to edit it
        $data['detalle_ingreso'] = $this->Detalle_ingreso_model->get_detalle_ingreso_kardex($detalleing_id);
        
        if(isset($data['detalle_ingreso']['detalleing_id']))
        {
            $this->load->library('form_validation');

			$this->form_validation->set_rules('detalleing_cantidad','Detalleing Cantidad','required');
			$this->form_validation->set_rules('detalleing_precio','Detalleing Precio','required');
			$this->form_validation->set_rules('detalleing_total','Detalleing Total','required');
		
			if($this->form_validation->run())     
            {   
                $params = array(
					'articulo_id' => $this->input->post('articulo_id'),
					'ingreso_id' => $this->input->post('ingreso_id'),
					'detalleing_cantidad' => $this->input->post('detalleing_cantidad'),
					'detalleing_precio' => $this->input->post('detalleing_precio'),
					'detalleing_total' => $this->input->post('detalleing_total'),
					'detalleing_salida' => $this->input->post('detalleing_salida'),
					'detalleing_saldo' => $this->input->post('detalleing_saldo'),
					'factura_numero' => $this->input->post('factura_numero'),
                );

                $this->Detalle_ingreso_model->update_detalle_ingreso($detalleing_id,$params);            
                //redirect('detalle_ingreso/index');
            }
            else
            {
				$this->load->model('Articulo_model');
				$data['all_articulo'] = $this->Articulo_model->get_all_articulo_kardex();

				$this->load->model('Ingreso_model');
				$data['all_ingreso'] = $this->Ingreso_model->get_all_ingreso_kardex();

                $data['_view'] = 'detalle_ingreso/edit';
                $this->load->view('layouts/main',$data);
            }
        }
        else
            show_error('The detalle_ingreso you are trying to edit does not exist.');
        
        }
    }     

    /*
     * Deleting detalle_ingreso
     */
    function remove($detalleing_id)
    {
        $this->Detalle_ingreso_model->bitacora("ACCESO A MODULO","REMOVE DETALLE INGRESO");
        
        if($this->acceso(16)){
            $detalle_ingreso = $this->Detalle_ingreso_model->get_detalle_ingreso($detalleing_id);

            // check if the detalle_ingreso exists before trying to delete it
            if(isset($detalle_ingreso['detalleing_id']))
            {
                $this->Detalle_ingreso_model->delete_detalle_ingreso($detalleing_id);
                redirect('detalle_ingreso/index');
            }
            else
                show_error('The detalle_ingreso you are trying to delete does not exist.');
        }
    }
    
}
